name: Scheduled Device Sync

on:
  schedule:
    # Cada 15 minutos (la lógica interna decide qué tareas corren por usuario/horario)
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  run-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Call internal scheduler endpoint
        env:
          INTERNAL_SYNC_TOKEN: ${{ secrets.INTERNAL_SYNC_TOKEN }}
        run: |
          if [ -z "$INTERNAL_SYNC_TOKEN" ]; then
            echo "Missing secrets.INTERNAL_SYNC_TOKEN" >&2
            exit 1
          fi

          curl -f -sS -X POST "https://api.gotogym.store/api/devices/internal/sync/run_due/" \
            -H "Content-Type: application/json" \
            -H "X-Internal-Token: ${INTERNAL_SYNC_TOKEN}" \
            -d '{"window_minutes":15,"max_users":50,"max_requests":50}'
          echo
