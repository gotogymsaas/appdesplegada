<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - GoToGym</title>
    <link rel="stylesheet" href="../../css/theme.css">
    <link rel="stylesheet" href="../../css/adminDashboard.css?v=2026-02-19">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body data-admin-page="metrics">

    <div class="admin-container">
        <!-- HEADER -->
        <div class="admin-header">
            <div>
                <div class="admin-title-wrap">
                    <div class="admin-menu-wrap">
                        <button id="adminMenuBtn" class="admin-menu-btn" type="button" aria-label="Men√∫ admin">‚ò∞</button>
                        <div id="adminMenuPanel" class="admin-menu-panel">
                            <a class="admin-menu-link active" href="./AdminDashboard.html">Dashboard M√©tricas</a>
                            <a class="admin-menu-link" href="./AdminUsers.html">Administraci√≥n de Usuarios</a>
                            <a class="admin-menu-link" href="./AdminNotifications.html">Panel de Notificaciones</a>
                            <button class="admin-menu-link admin-menu-link-danger" type="button" onclick="logout()">Cerrar Sesi√≥n</button>
                        </div>
                    </div>
                <h3>Panel de Administraci√≥n</h3>
                </div>
                <div class="admin-subtitle">Resumen general (agregado) ‚Äî <span id="rangeLabel">√∫ltimos 30 d√≠as</span></div>
            </div>
            <div class="admin-header-actions">
                <div class="range-control">
                    <label for="rangeSelect" class="range-label">Rango</label>
                    <select id="rangeSelect" class="input-field range-select">
                        <option value="1">D√≠a</option>
                        <option value="7">Semana</option>
                        <option value="30">Mes</option>
                        <option value="90" selected>90 d√≠as</option>
                        <option value="180">180 d√≠as</option>
                        <option value="270">270 d√≠as</option>
                        <option value="365">365 d√≠as</option>
                        <option value="730">2 a√±os</option>
                    </select>
                </div>

                <label class="compare-toggle" title="Muestra deltas vs el per√≠odo inmediatamente anterior">
                    <input id="compareToggle" type="checkbox" checked />
                    <span>Comparar</span>
                </label>

                <button class="btn btn-outline-teal btn-sm" onclick="refreshDashboard()">Actualizar</button>
                <span id="lastUpdated" class="last-updated">‚Äî</span>
            </div>
        </div>

        <!-- ESTRAT√âGICO: qu√© est√° pasando (direcci√≥n) -->
        <section class="layer-section" id="estrategico">
            <div class="layer-header">
                <div>
                    <div class="layer-title">Estrat√©gico</div>
                    <div class="layer-subtitle">Mensual/Trimestral: salud del negocio (crecimiento, monetizaci√≥n y engagement) con datos agregados.</div>
                </div>
                <span class="layer-chip" data-range-chip>√öltimos 30 d√≠as</span>
            </div>

            <div class="table-section revenue-hero">
                <div class="meta-row" style="margin-bottom: 6px;">
                    <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">Ingresos (estimado)</h2>
                    <span class="meta-chip">MRR estimado</span>
                </div>
                <div class="revenue-grid">
                    <div class="revenue-metric">
                        <div class="revenue-value" id="kpi-mrr-current">--</div>
                        <div class="revenue-label">MRR actual (Premium activos √ó precio)</div>
                        <div class="revenue-sub" id="kpi-mrr-current-sub">‚Äî</div>
                    </div>
                    <div class="revenue-metric">
                        <div class="revenue-value" id="kpi-mrr-projected-30d">--</div>
                        <div class="revenue-label">MRR proyectado (pr√≥x. 30 d√≠as)</div>
                        <div class="revenue-sub" id="kpi-mrr-projected-30d-sub">‚Äî</div>
                    </div>
                </div>
                <div class="chart-explainer">Algoritmo MVP: proyecta nuevas altas Premium con promedio m√≥vil de los √∫ltimos d√≠as del rango (sin churn/cancelaciones por ahora).</div>
            </div>

            <div class="charts-grid" style="margin-top: 16px;">
                <div class="table-section">
                    <div class="meta-row" style="margin-bottom: 10px;">
                        <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">MRR estimado (hist√≥rico)</h2>
                        <span class="meta-chip" data-range-chip>√öltimos 30 d√≠as</span>
                    </div>
                    <div class="chart-canvas-wrap chart-tall">
                        <canvas id="mrrHistoryChart"></canvas>
                    </div>
                    <div class="chart-explainer">Serie estimada del MRR usando Premium activos y altas Premium dentro del rango. √ötil para ver crecimiento de ingresos.</div>
                </div>

                <div class="table-section">
                    <div class="meta-row" style="margin-bottom: 10px;">
                        <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">Proyecci√≥n MRR (30 d√≠as)</h2>
                        <span class="meta-chip">Futuro</span>
                    </div>
                    <div class="chart-canvas-wrap chart-tall">
                        <canvas id="mrrProjectionChart"></canvas>
                    </div>
                    <div class="chart-explainer">Proyecci√≥n a 30 d√≠as con promedio m√≥vil de altas Premium (sin churn). Se recalcula al cambiar el rango.</div>
                </div>
            </div>

            <!-- KPI CARDS -->
            <div class="kpi-grid" style="margin-bottom: 0;">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-total">--</div>
                    <div class="kpi-label">Usuarios Totales</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" style="color: var(--secondary);" id="kpi-premium">--</div>
                    <div class="kpi-label">Usuarios Premium</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" style="color: var(--primary);" id="kpi-today">--</div>
                    <div class="kpi-label">Nuevos Hoy</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-7d">--</div>
                    <div class="kpi-label">Altas (7 d√≠as)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" style="color: var(--primary);" id="kpi-30d">--</div>
                    <div class="kpi-label">Altas (30 d√≠as)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" style="color: var(--secondary);" id="kpi-happy-7d">--</div>
                    <div class="kpi-label">Felicidad prom. (7 d√≠as)</div>
                </div>
            </div>

            <div class="mini-metrics-grid">
                <div class="mini-metric">
                    <div class="mini-value" id="kpi-active-users-7d">--</div>
                    <div class="mini-label">Engagement: activos (7d)</div>
                    <div class="mini-delta" id="delta-active-users-7d">Fuente: last_login</div>
                </div>
                <div class="mini-metric">
                    <div class="mini-value" id="kpi-range-signups">--</div>
                    <div class="mini-label">Crecimiento: altas (rango)</div>
                    <div class="mini-delta" id="delta-range-signups">‚Äî</div>
                </div>
                <div class="mini-metric">
                    <div class="mini-value" id="kpi-range-premium-signups">--</div>
                    <div class="mini-label">Monetizaci√≥n: altas Premium</div>
                    <div class="mini-delta" id="delta-range-premium-signups">‚Äî</div>
                </div>
                <div class="mini-metric">
                    <div class="mini-value" id="kpi-range-conversion">--</div>
                    <div class="mini-label">Monetizaci√≥n: conversi√≥n Premium</div>
                    <div class="mini-delta" id="delta-range-conversion">‚Äî</div>
                </div>
            </div>
        </section>

        <!-- T√ÅCTICO: por qu√© / palancas -->
        <section class="layer-section" id="tactico">
            <div class="layer-header">
                <div>
                    <div class="layer-title">T√°ctico</div>
                    <div class="layer-subtitle">Semanal: palancas (tendencias, composici√≥n y comparativos vs per√≠odo anterior).</div>
                </div>
                <span class="layer-chip" data-range-chip>√öltimos 30 d√≠as</span>
            </div>

            <!-- Charts (m√≠nimo 6) -->
            <div class="charts-grid">
                <div class="table-section">
                    <div class="meta-row" style="margin-bottom: 10px;">
                        <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">Felicidad Global</h2>
                        <span class="meta-chip" data-range-chip>√öltimos 30 d√≠as</span>
                    </div>
                    <div class="chart-canvas-wrap chart-tall">
                        <canvas id="globalChart"></canvas>
                    </div>
                    <div class="chart-explainer">Promedio diario (0‚Äì10). Sirve para ver tendencia y cambios a lo largo del tiempo.</div>
                </div>

                <div class="table-section">
                    <div class="meta-row" style="margin-bottom: 10px;">
                        <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">Distribuci√≥n de plan</h2>
                        <span class="meta-chip">Actual</span>
                    </div>
                    <div class="chart-canvas-wrap chart-tall">
                        <canvas id="planChart"></canvas>
                    </div>
                    <div class="chart-explainer">Distribuci√≥n actual seg√∫n el plan mostrado en la tabla de usuarios.</div>
                </div>

                <div class="table-section">
                    <div class="meta-row" style="margin-bottom: 10px;">
                        <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">Altas (Premium vs Gratis)</h2>
                        <span class="meta-chip" data-range-chip>√öltimos 30 d√≠as</span>
                    </div>
                    <div class="chart-canvas-wrap chart-tall">
                        <canvas id="signupsChart"></canvas>
                    </div>
                    <div class="chart-explainer">Altas por d√≠a separadas por plan. √ötil para medir adquisici√≥n y conversi√≥n a Premium.</div>
                </div>

                <div class="table-section">
                    <div class="meta-row" style="margin-bottom: 10px;">
                        <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">Tendencia de altas (prom. m√≥vil 7d)</h2>
                        <span class="meta-chip" data-range-chip>√öltimos 30 d√≠as</span>
                    </div>
                    <div class="chart-canvas-wrap chart-tall">
                        <canvas id="signupsTrendChart"></canvas>
                    </div>
                    <div class="chart-explainer">Suaviza el ruido diario para ver la tendencia real del crecimiento.</div>
                </div>

                <div class="table-section">
                    <div class="meta-row" style="margin-bottom: 10px;">
                        <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">Usuarios acumulados</h2>
                        <span class="meta-chip" data-range-chip>√öltimos 30 d√≠as</span>
                    </div>
                    <div class="chart-canvas-wrap chart-tall">
                        <canvas id="usersCumulativeChart"></canvas>
                    </div>
                    <div class="chart-explainer">Acumulado de usuarios creados dentro del rango. Refleja el ritmo de crecimiento.</div>
                </div>

                <div class="table-section">
                    <div class="meta-row" style="margin-bottom: 10px;">
                        <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">% Premium (acumulado)</h2>
                        <span class="meta-chip" data-range-chip>√öltimos 30 d√≠as</span>
                    </div>
                    <div class="chart-canvas-wrap chart-tall">
                        <canvas id="premiumShareChart"></canvas>
                    </div>
                    <div class="chart-explainer">Porcentaje Premium acumulado. Ayuda a ver si la monetizaci√≥n mejora o empeora.</div>
                </div>
            </div>
        </section>

        <section class="layer-section" id="operativo-metricas">
            <div class="layer-header">
                <div>
                    <div class="layer-title">Operativo (M√©tricas)</div>
                    <div class="layer-subtitle">Actividad diaria por 13 experiencias + benchmarking t√©cnico + costo unitario por usuario.</div>
                </div>
                <span class="layer-chip" data-range-chip>√öltimos 30 d√≠as</span>
            </div>

            <div class="table-section">
                <div class="meta-row" style="margin-bottom: 10px;">
                    <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">Actividad de experiencias (13)</h2>
                    <span class="meta-chip">Runtime</span>
                </div>
                <div class="ops-chart-wrap">
                    <canvas id="opsExperienceChart"></canvas>
                </div>
                <div class="chart-explainer">Trazas de ejecuci√≥n agregadas por d√≠a desde runtime (`llm.hito5.inference`).</div>
            </div>

            <div class="ops-grid" style="margin-top: 12px;">
                <div class="ops-card"><div class="ops-label">Requests</div><div class="ops-value" id="ops-req-total">--</div></div>
                <div class="ops-card"><div class="ops-label">Success rate</div><div class="ops-value" id="ops-success-rate">--</div></div>
                <div class="ops-card"><div class="ops-label">Latencia promedio</div><div class="ops-value" id="ops-avg-latency">--</div></div>
                <div class="ops-card"><div class="ops-label">Tokens (total)</div><div class="ops-value" id="ops-tokens-total">--</div></div>
                <div class="ops-card"><div class="ops-label">Costo estimado per√≠odo (COP)</div><div class="ops-value" id="ops-cost-cop">--</div></div>
                <div class="ops-card"><div class="ops-label">Costo unitario / usuario (COP)</div><div class="ops-value" id="ops-cost-per-user">--</div></div>
                <div class="ops-card"><div class="ops-label">Usuarios activos (rango)</div><div class="ops-value" id="ops-users-range">--</div></div>
            </div>
        </section>

        <!-- OPERATIVO: ejecutar acciones -->
        <section class="layer-section" id="operativo">
            <div class="layer-header">
                <div>
                    <div class="layer-title">Operativo</div>
                    <div class="layer-subtitle">Diario: ejecuci√≥n (usuarios, planes y notificaciones). Acciones sensibles piden motivo y quedan auditadas.</div>
                </div>
                <span class="layer-chip">Administraci√≥n</span>
            </div>

            <div class="dashboard-main">
                <div style="display:flex; flex-direction:column; gap:20px;">
                    <!-- Users Table -->
                    <div class="table-section">
                        <div class="toolbar">
                            <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">Usuarios</h2>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="searchInput" class="search-input"
                                    placeholder="Buscar por nombre o email..." onkeyup="filterUsers()">
                                <span class="selected-count" id="selectedCount">0 seleccionados</span>
                                <button class="btn btn-outline-gold btn-sm" style="border-color: var(--error); color: var(--error);" onclick="bulkDeleteUsers()">Eliminar</button>
                                <input type="file" id="bulkCreateInput" accept=".csv,text/csv" style="display:none" />
                                <input type="file" id="bulkPlanInput" accept=".csv,text/csv" style="display:none" />
                                <button class="btn btn-outline-teal btn-sm" onclick="triggerBulkCreate()">Carga masiva</button>
                                <button class="btn btn-outline-gold btn-sm" onclick="triggerBulkPlanUpdate()">Carga planes</button>
                                <button class="btn btn-primary btn-sm" onclick="openModal()">+ Nuevo</button>
                            </div>
                        </div>

                        <div class="segments-row">
                            <button class="segment-chip" onclick="applySegment('all')">Todos</button>
                            <button class="segment-chip" onclick="applySegment('new_7d')">Nuevos (7d)</button>
                            <button class="segment-chip" onclick="applySegment('premium_inactive_14d')">Premium inactivos (14d)</button>
                            <button class="segment-chip" onclick="applySegment('risk_high')">En riesgo (alto)</button>
                        </div>

                        <div class="bulk-help">
                            <div><strong>Carga masiva:</strong> CSV con columnas <code>username,email,password,plan</code> (plan: Gratis|Premium).</div>
                            <div><strong>Auto:</strong> Tambi√©n se acepta CSV con <code>email</code> (y <code>plan</code> opcional). Se generar√° usuario/contrase√±a y se descargar√° un CSV con credenciales creadas.</div>
                            <div><strong>Carga planes:</strong> CSV con columnas <code>email,plan</code> para activar/desactivar Premium manualmente.</div>
                        </div>

                        <div class="table-wrapper">
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th style="width: 34px;"><input id="selectAllUsers" type="checkbox" title="Seleccionar todos" /></th>
                                        <th>ID</th>
                                        <th>Usuario</th>
                                        <th>Email</th>
                                        <th>Plan</th>
                                        <th>Estado</th>
                                        <th>√ölt. actividad</th>
                                        <th>Riesgo</th>
                                        <th>Registro</th>
                                        <th>Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="usersBody">
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="table-section">
                        <div class="toolbar">
                            <h2 style="margin: 0; color: var(--text-main); font-size: 18px;">Auditor√≠a (reciente)</h2>
                            <button class="btn btn-outline-teal btn-sm" onclick="refreshAudit()">Actualizar</button>
                        </div>
                        <div class="audit-help">Acciones sensibles (eliminar, cambios de plan, broadcast) requieren motivo y quedan registradas.</div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Acci√≥n</th>
                                        <th>Entidad</th>
                                        <th>Actor</th>
                                        <th>Motivo</th>
                                    </tr>
                                </thead>
                                <tbody id="auditBody">
                                    <!-- Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: WIDGET -->
                <div class="widget-section">
                    <div class="widget-title">üîî Notificaciones</div>
                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">Env√≠a un broadcast real a todos los
                        dispositivos con notificaciones activas (PWA y m√≥vil).</p>

                    <button class="btn btn-outline-teal" style="width: 100%; margin-bottom: 10px;"
                        onclick="requestPermission()">Activar Permisos</button>

                    <select id="notifVariable" class="input-field" style="margin-bottom: 10px;">
                        <option value="s_sleep">Horas de sue√±o</option>
                        <option value="s_stress_inv">Nivel de Estr√©s</option>
                        <option value="s_energy">Nivel de Energ√≠a</option>
                    </select>

                    <button class="btn btn-primary" style="width: 100%;" onclick="sendDashboardNotification()">Enviar
                        Alerta</button>

                    <div class="privacy-card">
                        <div class="widget-title" style="margin-top: 0;">üîí Privacidad (resumen)</div>
                        <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">
                            Este panel usa datos agregados cuando es posible y est√° restringido a administradores.
                        </p>
                        <ul>
                            <li>Cuenta: nombre/usuario/email/plan.</li>
                            <li>T√©cnicos: IP, sesi√≥n (JWT), tokens push.</li>
                            <li>Bienestar: m√©tricas de entrenamiento y progreso.</li>
                            <li>Integraciones (opcional): sue√±o/actividad/FC/otras m√©tricas.</li>
                            <li>Archivos: perfil y adjuntos subidos voluntariamente.</li>
                        </ul>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 10px;">
                            Ver pol√≠tica: <a href="../info/PoliticaPrivacidad.html">Pol√≠ticas de Privacidad</a>
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Create User Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()"
                style="position:absolute; right:15px; top:15px; background:none; border:none; color:white; font-size:20px; cursor:pointer;">√ó</button>
            <h3 style="margin-bottom: 20px; text-align: center; color: var(--primary);">Crear Usuario</h3>
            <form id="createForm" onsubmit="handleCreate(event)">
                <div class="form-group">
                    <input type="text" id="newUsername" class="input-field" placeholder=" " required>
                    <label class="input-label">Usuario</label>
                </div>
                <!-- ... (Simplified for brevity, same fields) ... -->
                <div class="form-group">
                    <input type="email" id="newEmail" class="input-field" placeholder=" " required>
                    <label class="input-label">Email</label>
                </div>
                <div class="form-group">
                    <input type="password" id="newPassword" class="input-field" placeholder=" " required>
                    <label class="input-label">Contrase√±a</label>
                </div>
                <div class="form-group">
                    <select id="newPlan" class="input-field" style="color: grey;">
                        <option value="Gratis">Plan Gratis</option>
                        <option value="Premium">Plan Premium</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Registrar</button>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeEditModal()"
                style="position:absolute; right:15px; top:15px; background:none; border:none; color:white; font-size:20px; cursor:pointer;">√ó</button>
            <h3 style="margin-bottom: 20px; text-align: center; color: var(--secondary);">Editar Usuario</h3>
            <form id="editForm" onsubmit="handleEdit(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <input type="text" id="editUsername" class="input-field" placeholder=" " required>
                    <label class="input-label">Usuario</label>
                </div>
                <div class="form-group">
                    <input type="email" id="editEmail" class="input-field" placeholder=" " required>
                    <label class="input-label">Email</label>
                </div>
                <!-- Password is NOT editable here for security simplicity, typically reset is separate -->
                <div class="form-group">
                    <select id="editPlan" class="input-field" style="color: grey;">
                        <option value="Gratis">Plan Gratis</option>
                        <option value="Premium">Plan Premium</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary"
                    style="background: var(--secondary); color:black;">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="../../js/config.js?v=2026-02-19"></script>
    <script src="../../js/adminDashboard.js?v=2026-02-19"></script>
</body>
</html>
