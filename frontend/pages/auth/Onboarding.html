<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoToGym - Completa tu Perfil</title>
    <link rel="stylesheet" href="../../css/theme.css">
    <style>
        .page-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-text {
            text-align: center;
            margin-bottom: 40px;
        }

        .step-indicator {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #333;
        }

        .step-dot.active {
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        .unit-toggle {
            display: flex;
            background: #222;
            border-radius: 20px;
            padding: 2px;
            margin-left: 10px;
        }

        .unit-option {
            padding: 5px 10px;
            border-radius: 18px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-muted);
        }

        .unit-option.active {
            background: var(--primary);
            color: black;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="page-container">
        <!-- Header -->
        <div class="header-text">
            <h1 style="color: var(--secondary); margin-bottom: 10px;">¡Ya casi estás!</h1>
            <p style="color: var(--text-muted);">Necesitamos algunos datos para personalizar tu experiencia.</p>
        </div>

        <form id="onboardingForm" onsubmit="event.preventDefault(); handleSubmit();" style="width: 100%;">

            <!-- Age -->
            <div class="form-group">
                <input type="number" id="age" class="input-field" placeholder=" " required min="10" max="100">
                <label class="input-label">Edad (años)</label>
            </div>

            <!-- Weight -->
            <div class="form-group">
                <div style="display: flex; align-items: flex-end;">
                    <div style="flex-grow: 1; position: relative;">
                        <input type="number" id="weight" class="input-field" placeholder=" " required step="0.1">
                        <label class="input-label">Peso</label>
                    </div>
                    <div class="unit-toggle">
                        <div class="unit-option active" onclick="setWeightUnit('kg', this)">KG</div>
                        <div class="unit-option" onclick="setWeightUnit('lbs', this)">LBS</div>
                    </div>
                </div>
            </div>

            <!-- Height -->
            <div class="form-group">
                <div style="display: flex; align-items: flex-end;">
                    <div style="flex-grow: 1; position: relative;">
                        <input type="number" id="height" class="input-field" placeholder=" " required step="0.01">
                        <label class="input-label">Altura</label>
                    </div>
                    <div class="unit-toggle">
                        <div class="unit-option active" onclick="setHeightUnit('m', this)">M</div>
                        <div class="unit-option" onclick="setHeightUnit('cm', this)">CM</div>
                    </div>
                </div>
            </div>

            <button type="submit" id="btnContinue" class="btn btn-primary" style="margin-top: 40px;">
                Continuar
            </button>
        </form>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script src="../../js/config.js"></script>
    <script>
        let weightUnit = 'kg';
        let heightUnit = 'm';

        function setWeightUnit(unit, element) {
            weightUnit = unit;
            document.querySelectorAll('.unit-toggle')[0].querySelectorAll('.unit-option').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }

        function setHeightUnit(unit, element) {
            heightUnit = unit;
            document.querySelectorAll('.unit-toggle')[1].querySelectorAll('.unit-option').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }

        async function handleSubmit() {
            const btnContinue = document.getElementById('btnContinue');
            const age = document.getElementById('age').value;
            let weight = parseFloat(document.getElementById('weight').value);
            let height = parseFloat(document.getElementById('height').value);

            // Convert to standard units (kg and m) for backend
            if (weightUnit === 'lbs') {
                weight = weight * 0.453592;
            }
            if (heightUnit === 'cm') {
                height = height / 100;
            }

            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.username) {
                showToast("Error de sesión. Por favor ingresa nuevamente.", "error");
                setTimeout(() => window.location.href = 'indexInicioDeSesion.html', 2000);
                return;
            }

            try {
                btnContinue.textContent = "Guardando...";
                btnContinue.disabled = true;

                const res = await authFetch(API_URL + "update_profile/", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        username: user.username,
                        age: age,
                        weight: weight.toFixed(2),
                        height: height.toFixed(2)
                    }),
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    // Update local storage
                    localStorage.setItem("user", JSON.stringify(data.user));
                    showToast("¡Perfil completado!", "success");

                    setTimeout(() => {
                        window.location.href = '../profile/Perfil.html';
                    }, 1000);
                } else {
                    showToast(data.error || "Error al actualizar", "error");
                    btnContinue.textContent = "Continuar";
                    btnContinue.disabled = false;
                }

            } catch (error) {
                console.error(error);
                showToast("Error de conexión", "error");
                btnContinue.textContent = "Continuar";
                btnContinue.disabled = false;
            }
        }

        function showToast(message, type = "success") {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = "block";
            setTimeout(() => toast.style.display = "none", 3000);
        }
    </script>
</body>

</html>
