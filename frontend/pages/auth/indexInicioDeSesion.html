<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoToGym - Bienvenido</title>
    <link rel="stylesheet" href="../../css/theme.css">

    <!-- PWA Setup -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0FBFB0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/assets/images/apple-touch-icon.png">
    <style>
        .page-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }

        .welcome-tagline {
            margin-top: 16px;
            color: var(--text-muted);
            text-align: center;
            font-size: 13px;
            letter-spacing: 0.2px;
        }

        .legal-footer {
            position: absolute;
            bottom: 24px;
            width: 100%;
            text-align: center;
            font-size: 12px;
        }

        .legal-footer a {
            color: var(--text-muted);
            text-decoration: none;
        }

        .legal-footer a:hover {
            color: var(--primary);
        }

        /* State Management Classes */
        .hidden {
            display: none !important;
            opacity: 0;
        }

        .fade-in {
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

    </style>
</head>

<body>

    <div class="page-container">

        <!-- WELCOME STATE (Default) -->
        <div id="welcomeState" class="fade-in"
            style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <!-- Large Logo -->
            <div class="welcome-logo-container"
                style="overflow: hidden; padding: 0; display: flex; align-items: center; justify-content: center;">
                <img src="../../assets/images/recurso-16.png" alt="GoToGym Logo"
                    style="width: 60%; height: 60%; object-fit: contain; object-position: center;">
            </div>
            <div class="welcome-tagline">GoToGym tu plataforma de bienestar personalizado</div>

            <div style="width: 100%; padding: 0 20px; margin-top: 50px;">
                <button class="btn btn-outline-gold" onclick="showLogin()">
                    Iniciar Sesi칩n
                </button>

                <button class="btn btn-outline-teal" onclick="window.location.href='../auth/indexRegistrar.html'">
                    Registrar
                </button>
            </div>
        </div>

        <!-- LOGIN FORM STATE (Hidden initially) -->
        <div id="loginState" class="hidden" style="width: 100%;">

            <div class="logo-container" style="margin: 0 auto 40px auto; transform: scale(0.8);">
                <div class="logo-circle"
                    style="overflow: hidden; padding: 0; display: flex; align-items: center; justify-content: center;">
                    <img src="../../assets/images/recurso-16.png" alt="GoToGym Logo"
                        style="width: 60%; height: 60%; object-fit: contain; object-position: center;">
                </div>
            </div>

            <form id="loginForm" onsubmit="event.preventDefault();" style="width: 100%; padding: 20px;">
                <div class="form-group">
                    <input type="email" id="username" class="input-field" placeholder=" " required>
                    <label for="username" class="input-label">Email</label>
                </div>

                <div class="form-group" style="position: relative;">
                    <input type="password" id="password" class="input-field" placeholder=" " required>
                    <label for="password" class="input-label">Contrase침a</label>
                    <button type="button" id="togglePasswordBtn" aria-label="Mostrar contrase침a"
                        style="position:absolute; right:12px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-muted); font-size:18px; cursor:pointer;">
                        游녜
                    </button>
                </div>

                <div style="margin-top: 40px;">
                    <button type="submit" id="btnLogin" class="btn btn-primary">
                        Iniciar Sesi칩n
                    </button>
                </div>

                <div style="margin-top: 14px; text-align: center;">
                    <a href="#" id="forgotPasswordLink"
                        style="color: var(--primary); text-decoration: none; font-weight: 600; font-size: 13px;">
                        쯆lvidaste tu contrase침a?
                    </a>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <span style="color: var(--text-muted);">쯅o tienes cuenta? </span>
                    <a href="../auth/indexRegistrar.html"
                        style="color: var(--primary); text-decoration: none; font-weight: bold;">Reg칤strate</a>
                </div>
            </form>
        </div>

        <!-- PASSWORD RESET STATE (Hidden initially) -->
        <div id="resetState" class="hidden" style="width: 100%;">

            <div class="logo-container" style="margin: 0 auto 40px auto; transform: scale(0.8);">
                <div class="logo-circle"
                    style="overflow: hidden; padding: 0; display: flex; align-items: center; justify-content: center;">
                    <img src="../../assets/images/recurso-16.png" alt="GoToGym Logo"
                        style="width: 60%; height: 60%; object-fit: contain; object-position: center;">
                </div>
            </div>

            <form id="resetRequestForm" onsubmit="event.preventDefault();" style="width: 100%; padding: 20px;">
                <div id="resetRequestBlock">
                    <div class="form-group">
                        <input type="email" id="resetEmail" class="input-field" placeholder=" " required>
                        <label for="resetEmail" class="input-label">Email</label>
                    </div>

                    <div style="margin-top: 26px;">
                        <button type="submit" id="btnResetRequest" class="btn btn-primary">
                            Enviar enlace
                        </button>
                    </div>

                    <div style="margin-top: 16px; text-align: center;">
                        <a href="#" id="backToLoginLink"
                            style="color: var(--text-muted); text-decoration: none; font-weight: 600; font-size: 13px;">
                            Volver a iniciar sesi칩n
                        </a>
                    </div>
                </div>

                <div id="resetConfirmBlock" class="hidden">
                    <div class="form-group" style="position: relative;">
                        <input type="password" id="resetPassword" class="input-field" placeholder=" " required>
                        <label for="resetPassword" class="input-label">Nueva contrase침a</label>
                    </div>

                    <div class="form-group" style="position: relative;">
                        <input type="password" id="resetPassword2" class="input-field" placeholder=" " required>
                        <label for="resetPassword2" class="input-label">Confirmar contrase침a</label>
                    </div>

                    <div style="color: var(--text-muted); font-size: 12px; margin-top: -6px;">
                        M칤nimo 8 caracteres, 1 may칰scula y 1 n칰mero.
                    </div>

                    <div style="margin-top: 26px;">
                        <button type="submit" id="btnResetConfirm" class="btn btn-primary">
                            Guardar contrase침a
                        </button>
                    </div>

                    <div style="margin-top: 16px; text-align: center;">
                        <a href="#" id="backToLoginLink2"
                            style="color: var(--text-muted); text-decoration: none; font-weight: 600; font-size: 13px;">
                            Volver a iniciar sesi칩n
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <div class="legal-footer">
            <a href="../info/PoliticaPrivacidad.html">Pol칤ticas de privacidad</a>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="../../js/config.js"></script>
    <script>
        // State Management Functions
        function showLogin() {
            document.getElementById('welcomeState').style.display = 'none';
            const loginState = document.getElementById('loginState');
            loginState.classList.remove('hidden');
            loginState.classList.add('fade-in');
        }

        function showWelcome() {
            document.getElementById('loginState').classList.add('hidden');
            const welcomeState = document.getElementById('welcomeState');
            welcomeState.style.display = 'flex';
            welcomeState.classList.add('fade-in');
        }

        document.addEventListener("DOMContentLoaded", () => {
            const btnLogin = document.getElementById("btnLogin");
            const usernameInput = document.getElementById("username");
            const passwordInput = document.getElementById("password");

            const forgotPasswordLink = document.getElementById("forgotPasswordLink");
            const resetState = document.getElementById("resetState");
            const resetEmailInput = document.getElementById("resetEmail");
            const resetPasswordInput = document.getElementById("resetPassword");
            const resetPassword2Input = document.getElementById("resetPassword2");
            const btnResetRequest = document.getElementById("btnResetRequest");
            const btnResetConfirm = document.getElementById("btnResetConfirm");
            const resetRequestBlock = document.getElementById("resetRequestBlock");
            const resetConfirmBlock = document.getElementById("resetConfirmBlock");
            const backToLoginLink = document.getElementById("backToLoginLink");
            const backToLoginLink2 = document.getElementById("backToLoginLink2");

            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get("reset");

            const toggleBtn = document.getElementById("togglePasswordBtn");
            let isVisible = false;

            const updateVisibility = () => {
                passwordInput.type = isVisible ? "text" : "password";
                toggleBtn.setAttribute("aria-label", isVisible ? "Ocultar contrase침a" : "Mostrar contrase침a");
                toggleBtn.style.color = isVisible ? "var(--primary)" : "var(--text-muted)";
            };

            if (toggleBtn) {
                toggleBtn.addEventListener("click", () => {
                    isVisible = !isVisible;
                    updateVisibility();
                });
            }

            async function handleLogin() {
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();

                if (!username || !password) {
                    showToast("Por favor completa los campos", "error");
                    return;
                }

                try {
                    btnLogin.textContent = "Cargando...";
                    btnLogin.disabled = true;

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    const res = await fetch(API_URL + "login/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ username, password }),
                        signal: controller.signal,
                    });

                    clearTimeout(timeoutId);

                    const data = await res.json();

                    if (res.ok && data.success) {
                        showToast(`Bienvenido ${data.user.username}`, "success");
                        localStorage.setItem("user", JSON.stringify(data.user));
                        localStorage.setItem("isLoggedIn", "true");
                        // 游댏 JWT (infraestructura invisible)
                        if (data.access) {
                            if (typeof window.setAccessToken === "function") {
                                window.setAccessToken(data.access);
                            } else {
                                localStorage.setItem("access", data.access);
                                localStorage.setItem("token", data.access);
                            }
                        }
                        if (data.refresh) {
                            if (typeof window.setRefreshToken === "function") {
                                window.setRefreshToken(data.refresh);
                            } else {
                                localStorage.setItem("refresh", data.refresh);
                            }
                        }

                        // Verify Admin Status
                        console.log("User login:", data.user); // Debug
                        if (data.user.is_superuser === true) {
                            showToast("Redirigiendo a Panel Admin...");
                            setTimeout(() => {
                                window.location.href = "../admin/AdminDashboard.html";
                            }, 500); // Faster redirect
                            return;
                        }

                        // Normal User Flow
                        if (!data.user.age || !data.user.weight || !data.user.height) {
                            setTimeout(() => {
                                window.location.href = '../auth/Onboarding.html';
                            }, 1000);
                        } else {
                            setTimeout(() => {
                                window.location.href = '../profile/Perfil.html';
                            }, 1000);
                        }
                    } else {
                        showToast(data.error || "Error al iniciar sesi칩n", "error");
                        btnLogin.textContent = "Iniciar Sesi칩n";
                        btnLogin.disabled = false;
                    }
                } catch (error) {
                    const isTimeout = error && (error.name === 'AbortError');
                    if (!isTimeout) {
                        console.error(error);
                    }
                    // Show detailed error for debugging
                    showToast(
                        isTimeout
                            ? `Tiempo de espera agotado. Intenta de nuevo.`
                            : `Conexi칩n fallida: ${API_URL} - ${error.message}`,
                        "error"
                    );
                    btnLogin.textContent = "Iniciar Sesi칩n";
                    btnLogin.disabled = false;
                }
            }

            btnLogin.addEventListener("click", handleLogin);

            function showResetRequest() {
                document.getElementById('welcomeState').style.display = 'none';
                document.getElementById('loginState').classList.add('hidden');
                resetState.classList.remove('hidden');
                resetState.classList.add('fade-in');
                resetRequestBlock.classList.remove('hidden');
                resetConfirmBlock.classList.add('hidden');
                if (resetEmailInput) {
                    resetEmailInput.value = (usernameInput?.value || "").trim();
                    resetEmailInput.focus();
                }
            }

            function showResetConfirm() {
                document.getElementById('welcomeState').style.display = 'none';
                document.getElementById('loginState').classList.add('hidden');
                resetState.classList.remove('hidden');
                resetState.classList.add('fade-in');
                resetRequestBlock.classList.add('hidden');
                resetConfirmBlock.classList.remove('hidden');
                if (resetPasswordInput) resetPasswordInput.focus();
            }

            function showLoginState() {
                resetState.classList.add('hidden');
                showLogin();
            }

            function passwordStrong(pw) {
                return pw.length >= 8 && /[A-Z]/.test(pw) && /[0-9]/.test(pw);
            }

            async function handleResetRequest() {
                const email = (resetEmailInput?.value || "").trim().toLowerCase();
                if (!email) {
                    showToast("Ingresa tu email", "error");
                    return;
                }
                try {
                    btnResetRequest.textContent = "Enviando...";
                    btnResetRequest.disabled = true;
                    const res = await fetch(API_URL + "password/reset/request/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email }),
                    });
                    const data = await res.json().catch(() => ({}));
                    showToast(data.message || "Si el correo existe, enviaremos instrucciones.", "success");
                } catch (e) {
                    showToast("No se pudo enviar el enlace. Intenta de nuevo.", "error");
                } finally {
                    btnResetRequest.textContent = "Enviar enlace";
                    btnResetRequest.disabled = false;
                }
            }

            async function handleResetConfirm() {
                const pw1 = (resetPasswordInput?.value || "").trim();
                const pw2 = (resetPassword2Input?.value || "").trim();
                if (!pw1 || !pw2) {
                    showToast("Completa los campos", "error");
                    return;
                }
                if (pw1 !== pw2) {
                    showToast("Las contrase침as no coinciden", "error");
                    return;
                }
                if (!passwordStrong(pw1)) {
                    showToast("La contrase침a no cumple los requisitos", "error");
                    return;
                }
                if (!resetToken) {
                    showToast("Token inv치lido", "error");
                    return;
                }
                try {
                    btnResetConfirm.textContent = "Guardando...";
                    btnResetConfirm.disabled = true;
                    const res = await fetch(API_URL + "password/reset/confirm/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ token: resetToken, password: pw1 }),
                    });
                    const data = await res.json().catch(() => ({}));
                    if (res.ok && data.ok) {
                        showToast("Contrase침a actualizada. Inicia sesi칩n.", "success");
                        // Limpiar token de la URL
                        try {
                            const cleanUrl = window.location.pathname;
                            window.history.replaceState({}, document.title, cleanUrl);
                        } catch (_) { }
                        setTimeout(() => showLoginState(), 600);
                    } else {
                        const err = data.error || "No se pudo actualizar la contrase침a";
                        showToast(err === "token_expired" ? "El enlace expir칩. Solicita uno nuevo." : "Enlace inv치lido.", "error");
                        if (err === "token_expired" || err === "token_invalid") {
                            setTimeout(() => showResetRequest(), 600);
                        }
                    }
                } catch (e) {
                    showToast("No se pudo actualizar la contrase침a", "error");
                } finally {
                    btnResetConfirm.textContent = "Guardar contrase침a";
                    btnResetConfirm.disabled = false;
                }
            }

            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    showResetRequest();
                });
            }
            if (backToLoginLink) {
                backToLoginLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    showLoginState();
                });
            }
            if (backToLoginLink2) {
                backToLoginLink2.addEventListener("click", (e) => {
                    e.preventDefault();
                    showLoginState();
                });
            }
            const resetForm = document.getElementById("resetRequestForm");
            if (resetForm) {
                resetForm.addEventListener("submit", (e) => {
                    e.preventDefault();
                    if (resetToken) {
                        handleResetConfirm();
                    } else {
                        handleResetRequest();
                    }
                });
            }

            function showToast(message, type = "success") {
                const toast = document.getElementById("toast");
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = "block";
                setTimeout(() => toast.style.display = "none", 3000);
            }

            // Auto redirect if logged in (no interrumpir recuperaci칩n)
            if (!resetToken && localStorage.getItem('isLoggedIn') === 'true') {
                window.location.href = '../profile/Perfil.html';
            }

            // Si viene con token de recuperaci칩n, mostrar flujo de nueva contrase침a
            if (resetToken) {
                showResetConfirm();
            }
        });
    </script>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW Registered:', registration.scope))
                    .catch(err => console.log('SW Registration Failed:', err));
            });
        }
    </script>
</body>

</html>
