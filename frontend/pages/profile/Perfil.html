<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - GoToGym</title>
    <link rel="stylesheet" href="../../css/../../css/theme.css">

    <!-- PWA Setup -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0FBFB0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="apple-touch-icon" href="/assets/images/apple-touch-icon.png">
            <style>
                /* High Fidelity Profile Styles */
                body {
                    background-color: var(--bg-color);
                    color: var(--text-main);
                    font-family: 'Poppins', sans-serif;
                }
                
                .profile-container {
                    width: 100%;
                    max-width: 450px;
                    margin: 0 auto;
                    position: relative;
                    padding-bottom: 50px;
                }
                
                /* HEADER */
                .header-container {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px 25px;
                    margin-bottom: 20px;
                }
                
                .header-left {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                }
                
                .menu-btn {
                    background: none;
                    border: none;
                    cursor: pointer;
                    display: flex;
                    flex-direction: column;
                    gap: 5px;
                }
                
                .hamburger-line {
                    width: 28px;
                    height: 3px;
                    background-color: var(--primary);
                    /* Teal */
                    border-radius: 2px;
                }
                
                
                
                .header-logo {
                    font-size: 28px;
                    color: var(--secondary);
                    /* Gold */
                    font-weight: bold;
                    letter-spacing: -1px;
                }
                
                .edit-btn {
                    background: none;
                    border: none;
                    cursor: pointer;
                    padding: 5px;
                }
                
                /* GLOW LINE */
                .glow-line-container {
                    width: 100%;
                    height: 2px;
                    background: rgba(15, 191, 176, 0.2);
                    position: relative;
                    margin-top: 30px;
                    margin-bottom: 50px;
                }
                
                .glow-line {
                    width: 100%;
                    height: 100%;
                    background: var(--primary);
                    box-shadow: 0 0 15px var(--primary);
                }
                
                /* AVATAR */
                .avatar-section {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    margin-top: -100px;
                    /* Pull up over the line */
                    position: relative;
                    z-index: 2;
                }
                
                .avatar-wrapper {
                    position: relative;
                    width: 130px;
                    height: 130px;
                    margin-bottom: 20px;
                }
                
                .avatar {
                    width: 100%;
                    height: 100%;
                    border-radius: 50%;
                    background: var(--card-bg);
                    /* Placeholder image bg */
                    position: relative;
                    z-index: 2;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    font-size: 50px;
                    color: var(--text-muted);
                    overflow: hidden;
                    border: 2px solid transparent;
                }
                
                /* The teal ring around avatar */
                .avatar-glow {
                    position: absolute;
                    top: -5px;
                    left: -5px;
                    right: -5px;
                    bottom: -5px;
                    border-radius: 50%;
                    border: 2px solid var(--primary);
                    box-shadow: 0 0 15px rgba(15, 191, 176, 0.5);
                    z-index: 1;
                }
                
                .user-name {
                    font-size: 24px;
                    font-weight: 500;
                    color: var(--text-main);
                    margin: 0;
                    text-align: center;
                }
                
                .user-role {
                    font-size: 14px;
                    color: var(--text-muted);
                    /* Grey/White muted */
                    font-style: italic;
                    margin-top: 5px;
                }
                
                /* STATS */
                .stats-grid {
                    display: flex;
                    justify-content: center;
                    gap: 20px;
                    margin-top: 40px;
                    gap: 20px;
                    margin-top: 40px;
                    margin-bottom: 40px;
                }
                
                /* BADGES */
                .badges-grid {
                    display: flex;
                    justify-content: center;
                    gap: 15px;
                    flex-wrap: wrap;
                    margin-bottom: 40px;
                }

                /* EVOLUCI√ìN (Gamificaci√≥n minimalista) */
                .evolution-section {
                    width: 90%;
                    max-width: 420px;
                    margin: 0 auto 40px auto;
                    background: var(--card-bg);
                    border: 1px solid rgba(255, 255, 255, 0.06);
                    border-radius: 16px;
                    padding: 16px;
                    position: relative;
                    overflow: hidden;
                }

                .evolution-title {
                    color: var(--text-main);
                    font-size: 14px;
                    margin: 0 0 10px 0;
                    font-style: italic;
                }

                .identity-label {
                    color: var(--primary);
                    font-size: 13px;
                    margin-bottom: 10px;
                }

                .weekly-progress-text {
                    color: var(--text-muted);
                    font-size: 12px;
                    margin-bottom: 8px;
                }

                .progress-bar {
                    width: 100%;
                    height: 10px;
                    background: rgba(255, 255, 255, 0.08);
                    border-radius: 999px;
                    overflow: hidden;
                    border: 1px solid rgba(255, 255, 255, 0.06);
                }

                .progress-fill {
                    height: 100%;
                    width: 0%;
                    background: var(--primary);
                    border-radius: 999px;
                    transition: width 450ms ease;
                }

                .progress-bar.progress-pulse {
                    animation: progress-pulse 420ms ease;
                }

                .weekly-hint {
                    color: var(--text-muted);
                    font-size: 11px;
                    margin-top: 10px;
                }

                .evolution-help {
                    color: var(--text-muted);
                    font-size: 11px;
                    line-height: 1.4;
                    margin-top: 10px;
                    opacity: 0.95;
                }

                .missions-title {
                    color: var(--text-main);
                    font-size: 12px;
                    margin: 14px 0 8px 0;
                }

                .qaf-progress-note {
                    color: var(--text-muted);
                    font-size: 11px;
                    margin-bottom: 8px;
                }

                .qaf-experiences-grid {
                    display: grid;
                    grid-template-columns: 1fr;
                    gap: 6px;
                    margin-bottom: 8px;
                }

                .qaf-experience-item {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 8px 10px;
                    border-radius: 10px;
                    border: 1px solid rgba(255, 255, 255, 0.06);
                    background: rgba(255, 255, 255, 0.03);
                }

                .qaf-experience-label {
                    color: var(--text-main);
                    font-size: 11px;
                    line-height: 1.2;
                }

                .qaf-experience-status {
                    color: var(--text-muted);
                    font-size: 11px;
                    min-width: 42px;
                    text-align: right;
                }

                .qaf-experience-item.done {
                    border-color: rgba(15, 191, 176, 0.4);
                }

                .qaf-experience-item.done .qaf-experience-status {
                    color: var(--primary);
                }

                .qaf-experience-item.newly-done {
                    animation: mission-complete-pop 540ms ease;
                }

                .mission-item {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 10px 10px;
                    margin-bottom: 8px;
                    border-radius: 12px;
                    background: rgba(255, 255, 255, 0.04);
                    border: 1px solid rgba(255, 255, 255, 0.06);
                }

                .mission-left {
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                }

                .mission-label {
                    color: var(--text-main);
                    font-size: 12px;
                }

                .mission-sub {
                    color: var(--text-muted);
                    font-size: 11px;
                }

                .mission-status {
                    color: var(--primary);
                    font-size: 12px;
                    min-width: 56px;
                    text-align: right;
                }

                .mission-right {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-end;
                    gap: 6px;
                }

                .mission-action-btn {
                    background: transparent;
                    border: 1px solid var(--primary);
                    color: var(--primary);
                    border-radius: 999px;
                    padding: 5px 10px;
                    font-size: 10px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }

                .mission-action-btn:hover {
                    background: rgba(15, 191, 176, 0.08);
                }

                .mission-action-btn.claim-ready {
                    animation: claim-pulse 1.8s ease-in-out infinite;
                }

                .mission-item.completed {
                    border-color: rgba(15, 191, 176, 0.4);
                }

                .mission-item.newly-completed {
                    animation: mission-complete-pop 520ms ease;
                }

                .wow-row {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 10px;
                    margin: 8px 0 10px 0;
                }

                .wow-pill {
                    display: flex;
                    align-items: baseline;
                    gap: 6px;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 999px;
                    padding: 6px 10px;
                    color: var(--text-main);
                    font-size: 11px;
                    background: rgba(255, 255, 255, 0.03);
                }

                .wow-value {
                    color: var(--secondary);
                    font-size: 14px;
                    font-weight: 600;
                }

                .wow-value.bump {
                    animation: wow-bump 380ms ease;
                }

                .wow-delta {
                    color: var(--primary);
                    font-size: 10px;
                    opacity: 0;
                    transform: translateY(2px);
                    min-width: 0;
                }

                .wow-delta.show {
                    animation: wow-delta-float 850ms ease;
                }

                .wow-row.claim-success {
                    animation: claim-success-flash 520ms ease;
                }

                .claim-feedback {
                    color: var(--text-muted);
                    font-size: 11px;
                    margin-top: 6px;
                }

                .streak-row {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 8px;
                    margin-top: 10px;
                }

                .streak-chip {
                    color: var(--text-main);
                    border: 1px solid rgba(255, 255, 255, 0.12);
                    border-radius: 999px;
                    padding: 6px 10px;
                    font-size: 11px;
                    background: rgba(255, 255, 255, 0.03);
                }

                .streak-chip.streak-up {
                    animation: streak-up-glow 520ms ease;
                }

                .streak-tier {
                    color: var(--secondary);
                    font-size: 11px;
                    text-align: right;
                }

                .fx-toast {
                    position: absolute;
                    top: 8px;
                    left: 50%;
                    transform: translateX(-50%) translateY(-6px);
                    background: rgba(0, 0, 0, 0.72);
                    color: var(--text-main);
                    border: 1px solid rgba(255, 255, 255, 0.16);
                    border-radius: 999px;
                    padding: 6px 10px;
                    font-size: 11px;
                    opacity: 0;
                    pointer-events: none;
                    z-index: 3;
                }

                .fx-toast.show {
                    animation: fx-toast-in-out 1800ms ease;
                }

                .fx-particles {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    pointer-events: none;
                    z-index: 2;
                }

                .fx-particle {
                    position: absolute;
                    width: 6px;
                    height: 6px;
                    border-radius: 50%;
                    background: var(--secondary);
                    opacity: 0.9;
                    animation: particle-burst 680ms ease forwards;
                }

                .sfx-status {
                    position: absolute;
                    top: 8px;
                    right: 10px;
                    color: var(--text-muted);
                    font-size: 10px;
                    opacity: 0;
                    z-index: 3;
                }

                .sfx-status.show {
                    animation: sfx-status-pop 900ms ease;
                }

                .evolution-section.reveal {
                    animation: evo-reveal 300ms ease;
                }

                @keyframes wow-bump {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.18); }
                    100% { transform: scale(1); }
                }

                @keyframes wow-delta-float {
                    0% { opacity: 0; transform: translateY(2px); }
                    25% { opacity: 1; transform: translateY(-4px); }
                    100% { opacity: 0; transform: translateY(-10px); }
                }

                @keyframes progress-pulse {
                    0% { box-shadow: 0 0 0 rgba(15, 191, 176, 0); }
                    50% { box-shadow: 0 0 14px rgba(15, 191, 176, 0.32); }
                    100% { box-shadow: 0 0 0 rgba(15, 191, 176, 0); }
                }

                @keyframes claim-pulse {
                    0%, 100% { box-shadow: 0 0 0 rgba(15, 191, 176, 0); }
                    50% { box-shadow: 0 0 12px rgba(15, 191, 176, 0.35); }
                }

                @keyframes claim-success-flash {
                    0% { box-shadow: 0 0 0 rgba(212, 180, 106, 0); }
                    50% { box-shadow: 0 0 16px rgba(212, 180, 106, 0.35); }
                    100% { box-shadow: 0 0 0 rgba(212, 180, 106, 0); }
                }

                @keyframes mission-complete-pop {
                    0% { transform: scale(1); }
                    45% { transform: scale(1.02); }
                    100% { transform: scale(1); }
                }

                @keyframes streak-up-glow {
                    0% { box-shadow: 0 0 0 rgba(212, 180, 106, 0); }
                    45% { box-shadow: 0 0 14px rgba(212, 180, 106, 0.36); }
                    100% { box-shadow: 0 0 0 rgba(212, 180, 106, 0); }
                }

                @keyframes evo-reveal {
                    0% { opacity: 0.72; transform: translateY(4px); }
                    100% { opacity: 1; transform: translateY(0); }
                }

                @keyframes fx-toast-in-out {
                    0% { opacity: 0; transform: translateX(-50%) translateY(-6px); }
                    12% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    86% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    100% { opacity: 0; transform: translateX(-50%) translateY(-4px); }
                }

                @keyframes particle-burst {
                    0% { opacity: 0.95; transform: translate(0, 0) scale(1); }
                    100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.4); }
                }

                @keyframes sfx-status-pop {
                    0% { opacity: 0; transform: translateY(2px); }
                    35% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-2px); }
                }

                @media (prefers-reduced-motion: reduce) {
                    .mission-action-btn.claim-ready,
                    .mission-item.newly-completed,
                    .qaf-experience-item.newly-done,
                    .wow-value.bump,
                    .wow-row.claim-success,
                    .evolution-section.reveal,
                    .wow-delta.show,
                    .progress-bar.progress-pulse,
                    .fx-toast.show,
                    .sfx-status.show,
                    .streak-chip.streak-up,
                    .badge-item.newly-unlocked,
                    .happiness-section.mission-focus,
                    .fx-particle {
                        animation: none !important;
                    }
                }
                
                .badge-item {
                    background: linear-gradient(145deg, #1e1e1e, #252525);
                    border: 1px solid #333;
                    border-radius: 12px;
                    padding: 10px;
                    text-align: center;
                    width: 80px;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                }

                .badge-item.newly-unlocked {
                    animation: badge-unlock-pop 640ms ease;
                    border-color: rgba(212, 180, 106, 0.55);
                }

                @keyframes badge-unlock-pop {
                    0% { transform: scale(0.96); }
                    45% { transform: scale(1.06); }
                    100% { transform: scale(1); }
                }
                
                .badge-icon {
                    font-size: 24px;
                    display: block;
                    margin-bottom: 5px;
                }
                
                .badge-label {
                    font-size: 10px;
                    color: var(--text-muted);
                    line-height: 1.2;
                }
                
                .stat-item {
                    text-align: center;
                }
                
                .stat-value {
                    font-size: 32px;
                    color: var(--text-main);
                    font-weight: 400;
                    line-height: 1;
                    display: flex;
                    align-items: baseline;
                    justify-content: center;
                }
                
                .stat-unit {
                    font-size: 14px;
                    margin-left: 2px;
                }
                
                .stat-label {
                    color: var(--primary);
                    /* Teal labels */
                    font-size: 14px;
                    margin-top: 5px;
                }
                
                /* HAPPINESS INDEX */
                .happiness-section {
                    text-align: center;
                    margin-bottom: 60px;
                }

                .happiness-section.mission-focus {
                    animation: happiness-focus-pulse 640ms ease;
                }

                @keyframes happiness-focus-pulse {
                    0% { filter: none; }
                    45% { filter: drop-shadow(0 0 10px rgba(15, 191, 176, 0.35)); }
                    100% { filter: none; }
                }
                
                .happiness-title {
                    color: var(--text-main);
                    /* Title is white in image */
                    font-style: italic;
                    font-size: 16px;
                    margin-bottom: 20px;
                }
                
                .happiness-chart {
                    display: flex;
                    justify-content: center;
                }
                
                /* FOOTER ACTION */
                .footer-action {
                    text-align: center;
                    margin-top: 20px;
                }
                
                .gold-link {
                    color: var(--secondary);
                    text-decoration: none;
                    font-style: italic;
                    font-size: 16px;
                }

                body[data-theme="light"] .badge-item {
                    background: #F1F3F5;
                    border-color: #D5D9DD;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
                }
            </style>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
    
    <div class="profile-container">
        <!-- Header -->
        <div class="header-container">
            <div class="header-left">
                <button class="menu-btn" onclick="toggleMenu()">
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                    <div class="hamburger-line"></div>
                </button>
                <div class="header-logo">GoToGym</div>
            </div>
            
            <button class="edit-btn" onclick="window.location.href='../../pages/settings/CuentaYSeguridad.html'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                    d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13"
                    stroke="#0FBFB0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path
                    d="M18.5 2.50001C18.8978 2.10219 19.4374 1.87869 20 1.87869C20.5626 1.87869 21.1022 2.10219 21.5 2.50001C21.8978 2.89784 22.1213 3.4374 22.1213 4.00001C22.1213 4.56262 21.8978 5.10219 21.5 5.50001L12 15L8 16L9 12L18.5 2.50001Z"
                    stroke="#0FBFB0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Glowing Line -->
    <div class="glow-line-container">
        <div class="glow-line"></div>
    </div>
    
    <!-- Avatar Section -->
    <div class="avatar-section">
        <div class="avatar-wrapper">
            <div class="avatar-glow"></div>
            <div class="avatar" id="userAvatar">U</div>
        </div>
        
        <h2 class="user-name" id="userName">Cargando...</h2>
        <p class="user-role" id="userProfession">Profesi√≥n</p>
    </div>
    
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-value"><span id="stat-weight">--</span><span class="stat-unit">kg</span></div>
            <div class="stat-label">Peso</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="stat-age">--</div>
            <div class="stat-label">Edad</div>
        </div>
        <div class="stat-item">
            <div class="stat-value"><span id="stat-height">--</span><span class="stat-unit">m</span></div>
            <div class="stat-label">Altura</div>
        </div>
    </div>
    
    <!-- Happiness Index -->
    <div class="happiness-section">
        <div class="happiness-title">Indice de felicidad</div>
        <div class="happiness-chart" onclick="window.location.href='../../pages/forms/CuestionarioIF.html'"
            style="cursor: pointer;">
            <!-- SVG Heart Shape inside Circle -->
            <svg width="120" height="120" viewBox="0 0 120 120">
                <circle cx="60" cy="60" r="58" stroke="#0FBFB0" stroke-width="2" fill="none"
                style="filter: drop-shadow(0 0 5px #0FBFB0);" />
                <!-- Background heart -->
                <path
                d="M60 100C60 100 20 70 20 45C20 30 35 20 50 30C55 35 60 40 60 40C60 40 65 35 70 30C85 20 100 30 100 45C100 70 60 100 60 100Z"
                fill="none" stroke="rgba(15, 191, 176, 0.3)" stroke-width="1" />
                
                <!-- Text centered -->
                <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" fill="var(--text-main)" font-size="24"
                    font-family="'Poppins', sans-serif" font-weight="bold" id="happinessValue">--</text>
            </svg>
        </div>
        <div style="margin-top:10px; font-size: 12px; color: var(--primary);">Clic para calcular</div>
    </div>
    
    <!-- History Chart -->
    <div style="width: 90%; max-width: 400px; margin: 0 auto 40px auto;">
        <p style="color: var(--text-muted); text-align:center; font-size:14px; margin-bottom:10px;">Tu evoluci√≥n</p>
        <canvas id="happinessChart"></canvas>
    </div>
    
    <!-- Streak Section (Moved) -->
    <div style="text-align: center; margin-bottom: 40px;">
        <div style="font-size: 40px; color: var(--secondary); font-weight: bold; line-height: 1;">
            üî• <span id="stat-streak">0</span>
        </div>
        <div style="font-size: 14px; color: var(--secondary); margin-top: 5px;">Racha actual</div>
    </div>

    <!-- Evolution / Gamificaci√≥n -->
    <div id="evolutionSection" class="evolution-section" style="display:none;">
        <p class="evolution-title">Tu evoluci√≥n</p>
        <div class="identity-label" id="identityLabel">‚Äî</div>
                <div id="fxToast" class="fx-toast" aria-live="polite"></div>
                <div id="fxParticles" class="fx-particles" aria-hidden="true"></div>
                <div id="sfxStatus" class="sfx-status" aria-hidden="true"></div>
        <div class="weekly-progress-text" id="weeklyProgressText">Semana: 0/5 registros</div>
                <div class="progress-bar" aria-label="Progreso semanal" role="progressbar"
                         aria-valuemin="0" aria-valuemax="5" aria-valuenow="0"
                         id="weeklyProgressBar">
            <div class="progress-fill" id="weeklyProgressFill"></div>
        </div>
        <div class="wow-row">
                        <div class="wow-pill" aria-label="Puntos WOW">
                            Puntos <span class="wow-value" id="wowPoints" data-wow="0">0</span>
                            <span class="wow-delta" id="wowDelta" aria-hidden="true"></span>
                        </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button id="sfxToggleBtn" class="mission-action-btn" type="button" onclick="toggleSfx()">SFX: ON</button>
                <button id="claimDailyBtn" class="mission-action-btn" type="button" onclick="claimDailyReward()">Reclamar recompensa diaria</button>
            </div>
        </div>
        <div id="claimDailyFeedback" class="claim-feedback"></div>
        <div class="weekly-hint" id="weeklyHint">Activa tu racha con 1 acci√≥n al d√≠a: check-in, h√°bito o sincronizaci√≥n.</div>
                <div class="streak-row" aria-label="Racha">
                    <div class="streak-chip" id="streakChip">
                        üî• Racha: <span id="streakValue">0</span> d√≠as
                    </div>
                    <div class="streak-tier" id="streakTier">‚Äî</div>
                </div>
        <div class="evolution-help" id="evolutionHelp"></div>

        <div class="missions-title">Misi√≥n semanal</div>
        <div id="missionsContainer"></div>

        <div class="missions-title">13 Experiencias QAF</div>
        <div id="qafProgressNote" class="qaf-progress-note">Completadas: 0/13</div>
        <div id="qafExperiencesContainer" class="qaf-experiences-grid"></div>

        <div class="missions-title">Logros desbloqueados</div>
        <div id="badges-container" class="badges-grid"></div>
    </div>
    
    <!-- Badges Section -->
    <!-- Badges Section Removed -->
    
    
    
    <!-- Footer Link Removed -->
    </div>
    
    <!-- Menu Overlay -->
    <div id="menuOverlay" class="menu-overlay">
        <button class="menu-close-btn" onclick="toggleMenu()">√ó</button>
        <ul class="menu-links">
            <li><a href="../profile/Perfil.html" onclick="toggleMenu()">Perfil</a></li>
            <li><a href="../settings/Configuracion.html">Configuraci√≥n</a></li>
            <li><a href="../plans/Planes.html">Planes</a></li>
            <li><a href="../info/SobreNosotros.html">Sobre Nosotros</a></li>
            <li><a href="../info/Contactanos.html">Contacto</a></li>
            <li>
                <a href="/pages/auth/indexInicioDeSesion.html"
                     onclick="cerrarSesion(event)"
                     style="color: var(--error)">
                    Cerrar Sesi√≥n
                </a>
            </li>
        </ul>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>
    
    <script src="../../js/../../js/config.js"></script>
    <script>
        function toggleMenu() {
            const menu = document.getElementById('menuOverlay');
            menu.classList.toggle('active');
        }

        let gtgLastProfileFetchAt = 0;
        const GTG_PROFILE_FETCH_TTL_MS = 15000;
        let gtgPrevMissionCompleted = {};
        let gtgPrevExperienceCompleted = {};
        let gtgPrevBadges = [];
        let gtgPrevWowPoints = null;
        let gtgPrevWeeklyDone = null;
        let gtgPrevStreak = null;
        let gtgGamificationRendered = false;
        let gtgAudioCtx = null;
        let gtgSfxEnabled = localStorage.getItem('gtg_sfx_enabled') !== '0';

        function getStoredUser() {
            const raw = localStorage.getItem("user");
            if (!raw) return null;
            try {
                return JSON.parse(raw);
            } catch (e) {
                return null;
            }
        }

        function mergeAndStoreUser(patch) {
            const current = getStoredUser() || {};
            const next = { ...current, ...(patch || {}) };
            localStorage.setItem("user", JSON.stringify(next));
            return next;
        }

        function escapeHtml(value) {
            return String(value ?? '').replace(/[&<>'"]/g, (char) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[char] || char));
        }

        function getMissionAction(key) {
            const normalized = String(key || '').toLowerCase();
            if (normalized === 'checkins') {
                return { label: 'Ir al check-in', href: '../../pages/forms/CuestionarioIF.html' };
            }
            if (normalized === 'sync') {
                return { label: 'Ir a dispositivos', href: '../../pages/settings/Dispositivos.html' };
            }
            if (normalized === 'if_delta') {
                return { label: 'Ver evoluci√≥n IF', action: 'focus_happiness' };
            }
            return null;
        }

        function runMissionAction(key) {
            const action = getMissionAction(key);
            if (!action) return;
            if (action.action === 'focus_happiness') {
                focusHappinessSection();
                return;
            }
            if (!action.href) return;
            window.location.href = action.href;
        }

        function focusHappinessSection() {
            const section = document.querySelector('.happiness-section');
            if (!section) return;
            section.classList.remove('mission-focus');
            void section.offsetWidth;
            section.classList.add('mission-focus');
            section.scrollIntoView({ behavior: 'smooth', block: 'center' });
            showFxToast('Revisa tu evoluci√≥n IF y registra un nuevo check-in');
        }

        function prefersReducedMotion() {
            return !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
        }

        function syncSfxToggleUi() {
            const sfxBtn = document.getElementById('sfxToggleBtn');
            if (!sfxBtn) return;
            sfxBtn.textContent = gtgSfxEnabled ? 'SFX: ON' : 'SFX: OFF';
            sfxBtn.style.opacity = gtgSfxEnabled ? '1' : '0.7';
        }

        function toggleSfx() {
            gtgSfxEnabled = !gtgSfxEnabled;
            localStorage.setItem('gtg_sfx_enabled', gtgSfxEnabled ? '1' : '0');
            syncSfxToggleUi();
            showSfxStatus(gtgSfxEnabled ? 'SFX ON' : 'SFX OFF');
            showToast(gtgSfxEnabled ? 'Sonidos activados' : 'Sonidos desactivados', 'success');
            if (gtgSfxEnabled) {
                playPositiveSfx('claim');
            }
        }

        function playSfx(kind = 'PING_SOFT') {
            if (kind === 'CHIME_GOAL') {
                playPositiveSfx('mission');
                return;
            }
            if (kind === 'PING_SOFT') {
                playPositiveSfx('claim');
                return;
            }
            playPositiveSfx('success');
        }

        function playPositiveSfx(kind = 'success') {
            if (!gtgSfxEnabled || prefersReducedMotion()) return;
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) return;
                if (!gtgAudioCtx) gtgAudioCtx = new AudioCtx();
                if (gtgAudioCtx.state === 'suspended') {
                    gtgAudioCtx.resume();
                }
                const now = gtgAudioCtx.currentTime;
                const osc = gtgAudioCtx.createOscillator();
                const gain = gtgAudioCtx.createGain();
                const baseFreq = kind === 'claim' ? 740 : (kind === 'mission' ? 660 : 620);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(baseFreq, now);
                osc.frequency.exponentialRampToValueAtTime(baseFreq * 1.22, now + 0.09);
                gain.gain.setValueAtTime(0.0001, now);
                gain.gain.exponentialRampToValueAtTime(0.08, now + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.16);
                osc.connect(gain);
                gain.connect(gtgAudioCtx.destination);
                osc.start(now);
                osc.stop(now + 0.17);
            } catch (e) {
                if (window.GTG_DEBUG) console.warn('[Perfil] playPositiveSfx fall√≥', e);
            }
        }

        function animateStreakIncrease(previousStreak, currentStreak) {
            if (previousStreak === null || currentStreak <= previousStreak) return;
            const streakChip = document.getElementById('streakChip');
            if (!streakChip) return;
            streakChip.classList.remove('streak-up');
            void streakChip.offsetWidth;
            streakChip.classList.add('streak-up');
            playSfx('CHIME_GOAL');
            triggerSuccessHaptic();
        }

        function triggerSuccessHaptic() {
            try {
                if (navigator && typeof navigator.vibrate === 'function') {
                    navigator.vibrate(20);
                }
            } catch (e) {
                if (window.GTG_DEBUG) console.warn('[Perfil] vibrate fall√≥', e);
            }
        }

        function animateWowPointsChange(previousPoints, currentPoints) {
            if (previousPoints === null || currentPoints <= previousPoints) return;
            const wowPoints = document.getElementById('wowPoints');
            const wowRow = document.querySelector('.wow-row');
            const delta = currentPoints - previousPoints;
            if (wowPoints) {
                wowPoints.classList.remove('bump');
                void wowPoints.offsetWidth;
                wowPoints.classList.add('bump');
                wowPoints.dataset.wow = String(currentPoints);
            }
            if (wowRow) {
                wowRow.classList.remove('claim-success');
                void wowRow.offsetWidth;
                wowRow.classList.add('claim-success');
            }
            animateWowDelta(delta);
            burstFxParticles();
            playSfx('PING_SOFT');
            triggerSuccessHaptic();
        }

        function animateProgressPulse(previousDone, currentDone) {
            if (previousDone === null || currentDone <= previousDone) return;
            const progressBar = document.getElementById('weeklyProgressBar');
            if (!progressBar) return;
            progressBar.classList.remove('progress-pulse');
            void progressBar.offsetWidth;
            progressBar.classList.add('progress-pulse');
            playSfx('CHIME_GOAL');
            showFxToast('¬°Progreso semanal actualizado!');
        }

        function animateWowDelta(delta) {
            if (!(delta > 0)) return;
            const wowDelta = document.getElementById('wowDelta');
            if (!wowDelta) return;
            wowDelta.textContent = `+${Math.round(delta)} WOW`;
            wowDelta.classList.remove('show');
            void wowDelta.offsetWidth;
            wowDelta.classList.add('show');
        }

        function showFxToast(message) {
            const el = document.getElementById('fxToast');
            if (!el || !message) return;
            el.textContent = String(message);
            el.classList.remove('show');
            void el.offsetWidth;
            el.classList.add('show');
        }

        function showSfxStatus(message) {
            const el = document.getElementById('sfxStatus');
            if (!el || !message) return;
            el.textContent = String(message);
            el.classList.remove('show');
            void el.offsetWidth;
            el.classList.add('show');
        }

        function burstFxParticles() {
            if (prefersReducedMotion()) return;
            const host = document.getElementById('fxParticles');
            if (!host) return;
            host.innerHTML = '';
            for (let i = 0; i < 8; i += 1) {
                const p = document.createElement('span');
                p.className = 'fx-particle';
                const tx = Math.round((Math.random() * 64) - 32);
                const ty = Math.round(-12 - (Math.random() * 44));
                p.style.left = `${44 + Math.round(Math.random() * 12)}%`;
                p.style.top = `${58 + Math.round(Math.random() * 16)}%`;
                p.style.setProperty('--tx', `${tx}px`);
                p.style.setProperty('--ty', `${ty}px`);
                host.appendChild(p);
            }
            setTimeout(() => {
                host.innerHTML = '';
            }, 740);
        }

        function applyUserToUI(user, opts = {}) {
            const silent = opts.silent !== false;
            if (!user) return;

            document.getElementById('userName').textContent = user.full_name || user.username || "Nombres y apellidos";

            const avatarEl = document.getElementById('userAvatar');
            const originalAvatarValue = user.profile_picture || "";
            const profilePictureUrl = user.profile_picture_url || "";
            const resolvedFallbackUrl = window.resolveMediaUrl
                ? window.resolveMediaUrl(originalAvatarValue)
                : originalAvatarValue;
            const defaultAvatarUrl = window.DEFAULT_AVATAR_URL || "";
            const preferredUrl = profilePictureUrl || resolvedFallbackUrl;
            const finalUrl = preferredUrl || defaultAvatarUrl;
            if (window.GTG_DEBUG) {
                console.debug('[Avatar][Perfil] profile_picture original:', originalAvatarValue);
                console.debug('[Avatar][Perfil] profile_picture_url:', profilePictureUrl);
                console.debug('[Avatar][Perfil] default avatar URL:', defaultAvatarUrl);
                console.debug('[Avatar][Perfil] profile_picture final URL:', finalUrl);
            }

            if (finalUrl) {
                const avatarImg = new Image();
                avatarImg.src = finalUrl;
                avatarImg.style.width = '100%';
                avatarImg.style.height = '100%';
                avatarImg.style.objectFit = 'cover';
                avatarImg.onload = () => {
                    avatarEl.innerHTML = '';
                    avatarEl.appendChild(avatarImg);
                    avatarEl.style.background = 'transparent';
                };
                avatarImg.onerror = (errorEvent) => {
                    logAvatarLoadFailure('Perfil', finalUrl, errorEvent);
                    if (defaultAvatarUrl && preferredUrl && preferredUrl !== defaultAvatarUrl) {
                        const fallbackImg = new Image();
                        const fallbackUrl = defaultAvatarUrl;
                        fallbackImg.src = fallbackUrl;
                        fallbackImg.style.width = '100%';
                        fallbackImg.style.height = '100%';
                        fallbackImg.style.objectFit = 'cover';
                        fallbackImg.onload = () => {
                            avatarEl.innerHTML = '';
                            avatarEl.appendChild(fallbackImg);
                            avatarEl.style.background = 'transparent';
                        };
                        fallbackImg.onerror = (fallbackErrorEvent) => {
                            logAvatarLoadFailure('Perfil', fallbackUrl, fallbackErrorEvent);
                            avatarEl.textContent = (user.username || "U").charAt(0).toUpperCase();
                            avatarEl.style.background = '';
                        };
                        return;
                    }
                    avatarEl.textContent = (user.username || "U").charAt(0).toUpperCase();
                    avatarEl.style.background = '';
                };
            } else {
                avatarEl.textContent = (user.username || "U").charAt(0).toUpperCase();
            }

            document.getElementById('userProfession').textContent = user.profession || "Profesi√≥n";
            document.getElementById("stat-weight").innerText = user.weight || "--";
            document.getElementById("stat-height").innerText = user.height || "--";
            document.getElementById("stat-age").innerText = user.age || "--";
            document.getElementById("stat-streak").innerText = user.current_streak || "0";

            // Gamificaci√≥n (misiones + progreso + identidad)
            try {
                const evo = document.getElementById('evolutionSection');
                const g = user.gamification;
                if (!evo || !g || !g.weekly || !g.weekly.progress || !g.missions) {
                    if (evo) evo.style.display = 'none';
                } else {
                    evo.style.display = '';
                    if (!gtgGamificationRendered) {
                        evo.classList.add('reveal');
                        gtgGamificationRendered = true;
                    }
                    const identityLabel = document.getElementById('identityLabel');
                    if (identityLabel && g.identity && g.identity.label) {
                        identityLabel.textContent = g.identity.label;
                    }

                    const done = Number(g.weekly.progress.done || 0);
                    const target = Number(g.weekly.progress.target || 5);
                    const weeklyText = document.getElementById('weeklyProgressText');
                    if (weeklyText) weeklyText.textContent = `Semana: ${done}/${target} registros`;
                    const fill = document.getElementById('weeklyProgressFill');
                    const progressBar = document.getElementById('weeklyProgressBar');
                    const pct = target > 0 ? Math.min(100, Math.round((done / target) * 100)) : 0;
                    if (fill) fill.style.width = `${pct}%`;
                    if (progressBar) {
                        progressBar.setAttribute('aria-valuemax', String(target));
                        progressBar.setAttribute('aria-valuenow', String(Math.min(done, target)));
                    }
                    animateProgressPulse(gtgPrevWeeklyDone, done);
                    gtgPrevWeeklyDone = done;

                    const missionsEl = document.getElementById('missionsContainer');
                    if (missionsEl) {
                        const items = (g.missions.items && Array.isArray(g.missions.items)) ? g.missions.items : [];
                        const nextMissionCompleted = {};
                        missionsEl.innerHTML = '';
                        items.forEach((m) => {
                            if (!m) return;
                            const label = m.label || m.key || 'Misi√≥n';
                            const progress = (m.progress !== undefined && m.progress !== null) ? m.progress : 0;
                            const targetVal = (m.target !== undefined && m.target !== null) ? m.target : 0;
                            const completed = !!m.completed;
                            const status = completed ? '‚úì' : `${progress}/${targetVal}`;

                            const key = String(m.key || '').toLowerCase();
                            nextMissionCompleted[key] = completed;
                            let howTo = 'Haz 1 acci√≥n v√°lida hoy para activar tu evoluci√≥n.';
                            if (key === 'checkins') {
                                howTo = 'Responde el check-in (Cuestionario IF) para contar un registro.';
                            } else if (key === 'sync') {
                                howTo = 'Ve a Dispositivos y sincroniza (cuenta solo si trae datos reales).';
                            } else if (key === 'if_delta') {
                                howTo = 'Mejora tu IF esta semana: ajusta h√°bitos y vuelve a calcular.';
                            }

                            const row = document.createElement('div');
                            row.className = `mission-item ${completed ? 'completed' : ''}`.trim();
                            const wasCompleted = !!gtgPrevMissionCompleted[key];
                            if (completed && wasCompleted === false && gtgGamificationRendered) {
                                row.classList.add('newly-completed');
                                playPositiveSfx('mission');
                                triggerSuccessHaptic();
                            }
                                                        const action = completed ? null : getMissionAction(key);
                                                        const actionButton = action
                                                                ? `<button class="mission-action-btn" type="button" onclick="runMissionAction('${escapeHtml(key)}')">${escapeHtml(action.label)}</button>`
                                                                : '';
                            row.innerHTML = `
                              <div class="mission-left">
                                <div class="mission-label">${label}</div>
                                <div class="mission-sub">${howTo}</div>
                              </div>
                                                            <div class="mission-right">
                                                                <div class="mission-status">${status}</div>
                                                                ${actionButton}
                                                            </div>
                            `;
                            missionsEl.appendChild(row);
                        });
                        gtgPrevMissionCompleted = nextMissionCompleted;
                    }

                                        const wow = g.wow || {};
                                        const currentWowPoints = Number(
                                            wow.points_total
                                            ?? (wow.xp && wow.xp.total)
                                            ?? 0
                                        );
                                        const wowPoints = document.getElementById('wowPoints');
                                        if (wowPoints) {
                                            wowPoints.textContent = String(currentWowPoints);
                                            wowPoints.dataset.wow = String(currentWowPoints);
                                        }
                                        animateWowPointsChange(gtgPrevWowPoints, currentWowPoints);
                                        gtgPrevWowPoints = currentWowPoints;
                                        const claimBtn = document.getElementById('claimDailyBtn');
                                        syncSfxToggleUi();
                                        const claimFeedback = document.getElementById('claimDailyFeedback');
                                        const dailyReward = wow.daily_reward || {};
                                        const rewardAmount = Number(
                                            dailyReward.amount
                                            ?? dailyReward.points
                                            ?? 0
                                        );
                                        const claimedToday = typeof dailyReward.claimed_today === 'boolean'
                                            ? dailyReward.claimed_today
                                            : (typeof dailyReward.available === 'boolean' ? !dailyReward.available : false);
                                        if (claimBtn) {
                                                claimBtn.disabled = claimedToday;
                                            claimBtn.classList.toggle('claim-ready', !claimedToday);
                                                claimBtn.style.opacity = claimedToday ? '0.6' : '1';
                                                claimBtn.style.cursor = claimedToday ? 'default' : 'pointer';
                                                claimBtn.textContent = claimedToday
                                                        ? 'Recompensa reclamada hoy'
                                                        : `Reclamar +${rewardAmount} puntos`;
                                        }
                                        if (claimFeedback) {
                                                claimFeedback.textContent = claimedToday
                                                        ? 'Recompensa diaria ya reclamada. Vuelve ma√±ana para sumar m√°s puntos.'
                                                        : 'Reclama tu recompensa diaria para mantener tu momentum.';
                                        }

                    const hint = document.getElementById('weeklyHint');
                    if (hint) {
                        const tier = g.streak_tier && g.streak_tier.current ? g.streak_tier.current.label : null;
                        hint.textContent = tier
                            ? `Estado: ${tier}. Activa tu racha con 1 acci√≥n al d√≠a: check-in, h√°bito o sincronizaci√≥n.`
                            : 'Activa tu racha con 1 acci√≥n al d√≠a: check-in, h√°bito o sincronizaci√≥n.';
                    }

                    const streakValue = document.getElementById('streakValue');
                    const streakTier = document.getElementById('streakTier');
                    const currentStreak = Number(g.streak || user.current_streak || 0);
                    if (streakValue) streakValue.textContent = String(currentStreak);
                    if (streakTier) {
                        const currentTier = g.streak_tier && g.streak_tier.current ? g.streak_tier.current.label : '‚Äî';
                        streakTier.textContent = currentTier;
                    }
                    animateStreakIncrease(gtgPrevStreak, currentStreak);
                    gtgPrevStreak = currentStreak;

                    const qafProgressNote = document.getElementById('qafProgressNote');
                    const qafContainer = document.getElementById('qafExperiencesContainer');
                    const experiences = g.experiences || {};
                    const summary = experiences.summary || {};
                    const expItems = Array.isArray(experiences.items) ? experiences.items : [];
                    const total = Number(summary.total || expItems.length || 13);
                    const completed = Number(summary.completed || 0);
                    const completedWeek = Number(summary.completed_week || 0);
                    if (qafProgressNote) {
                        qafProgressNote.textContent = `Completadas: ${completed}/${total} ¬∑ Esta semana: ${completedWeek}`;
                    }
                    if (qafContainer) {
                        qafContainer.innerHTML = '';
                        const nextExperienceCompleted = {};
                        let hasNewExperience = false;
                        expItems.forEach((exp) => {
                            if (!exp) return;
                            const label = escapeHtml(exp.label || exp.code || 'Experiencia');
                            const done = !!exp.completed;
                            const doneWeek = !!exp.completed_week;
                            const status = done ? (doneWeek ? '‚úì semana' : '‚úì') : '‚óã';
                            const expKey = String(exp.code || exp.label || '').toLowerCase();
                            nextExperienceCompleted[expKey] = done;
                            const row = document.createElement('div');
                            row.className = `qaf-experience-item ${done ? 'done' : ''}`.trim();
                            if (done && gtgPrevExperienceCompleted[expKey] === false && gtgGamificationRendered) {
                                row.classList.add('newly-done');
                                hasNewExperience = true;
                            }
                            row.innerHTML = `
                              <div class="qaf-experience-label">${label}</div>
                              <div class="qaf-experience-status">${status}</div>
                            `;
                            qafContainer.appendChild(row);
                        });
                        gtgPrevExperienceCompleted = nextExperienceCompleted;
                        if (hasNewExperience) {
                            showFxToast('¬°Nueva experiencia QAF completada!');
                            playSfx('CHIME_GOAL');
                        }
                    }

                    const help = document.getElementById('evolutionHelp');
                    if (help) {
                        const nextTier = (g.streak_tier && g.streak_tier.next) ? g.streak_tier.next : null;
                        const nextText = nextTier && nextTier.threshold
                            ? `Siguiente hito: ${nextTier.threshold} d√≠as (${nextTier.label}).`
                            : '';

                        // Documentos (planes) para activar mejores recomendaciones del Coach
                        const docs = g.documents || {};
                        const needNutrition = !(docs.nutrition_plan && docs.nutrition_plan.uploaded);
                        const needTraining = !(docs.training_plan && docs.training_plan.uploaded);
                        let docsText = '';
                        if (needNutrition && needTraining) {
                            docsText = 'Extra: Sube tu Plan de Nutrici√≥n y tu Plan de Entrenamiento (Configuraci√≥n) para activar recomendaciones m√°s coherentes.';
                        } else if (needNutrition) {
                            docsText = 'Extra: Sube tu Plan de Nutrici√≥n (Configuraci√≥n) para activar recomendaciones m√°s coherentes.';
                        } else if (needTraining) {
                            docsText = 'Extra: Sube tu Plan de Entrenamiento (Configuraci√≥n) para activar recomendaciones m√°s coherentes.';
                        }

                        help.textContent = `C√≥mo activar: 1) Check-in IF (responder el cuestionario) 2) Actualizar un indicador (sue√±o, pasos, estr√©s...) 3) Sincronizar un dispositivo. ${docsText} ${nextText}`.replace(/\s+/g, ' ').trim();
                    }
                }
            } catch (e) {
                // no-op
            }

            if (user.happiness_index !== undefined && user.happiness_index !== null) {
                const percent = Math.round(user.happiness_index * 10);
                document.getElementById('happinessValue').textContent = percent + "%";
                loadChart(user.username);
            } else {
                document.getElementById('happinessValue').textContent = "--";
                document.getElementById("happinessValue").style.fontSize = "16px";
            }

            const badgesContainer = document.getElementById("badges-container");
            if (!badgesContainer) {
                if (window.GTG_DEBUG) console.warn("badges-container no existe en este template, se omite Render Badges");
            } else {
                if (user.badges && user.badges.length > 0) {
                    badgesContainer.innerHTML = "";
                    const prevBadgesSet = new Set((gtgPrevBadges || []).map((x) => String(x)));
                    const nextBadges = [];
                    let hasNewBadge = false;
                    const badgeConfig = {
                        "iniciado": { icon: "üöÄ", label: "Iniciado" },
                        "on_fire": { icon: "üî•", label: "On Fire" },
                        "zen_master": { icon: "üßò", label: "Zen Master" }
                    };
                    user.badges.forEach(badgeKey => {
                        nextBadges.push(String(badgeKey));
                        const config = badgeConfig[badgeKey] || { icon: "üèÖ", label: badgeKey };
                        const isNew = !prevBadgesSet.has(String(badgeKey)) && gtgGamificationRendered;
                        if (isNew) hasNewBadge = true;
                        const badgeHTML = `
                        <div class="badge-item ${isNew ? 'newly-unlocked' : ''}">
                          <span class="badge-icon">${config.icon}</span>
                          <span class="badge-label">${config.label}</span>
                        </div>
                      `;
                        badgesContainer.innerHTML += badgeHTML;
                    });
                    gtgPrevBadges = nextBadges;
                    if (hasNewBadge) {
                        showFxToast('¬°Nuevo logro desbloqueado!');
                        playSfx('CHIME_GOAL');
                        triggerSuccessHaptic();
                    }
                } else {
                    badgesContainer.innerHTML = `<p style="color:#666;font-size:12px;">A√∫n no tienes logros.</p>`;
                    gtgPrevBadges = [];
                }
            }

            if (!silent) {
                showToast("Perfil actualizado", "success");
            }
        }

        async function fetchUserProfile(opts = {}) {
            const silent = opts.silent !== false;
            const user = getStoredUser();
            const username = user?.username;
            if (!username || !window.API_URL || typeof authFetch !== 'function') return null;

            const now = Date.now();
            if (now - gtgLastProfileFetchAt < GTG_PROFILE_FETCH_TTL_MS) return null;
            gtgLastProfileFetchAt = now;

            try {
                const res = await authFetch(`${API_URL}user_profile/?username=${encodeURIComponent(username)}`);
                if (!res.ok) return null;
                const data = await res.json();
                let merged = mergeAndStoreUser(data);

                if (!merged?.gamification) {
                    try {
                        const gsRes = await authFetch(`${API_URL}gamification/status/`);
                        if (gsRes.ok) {
                            const gsData = await gsRes.json();
                            merged = mergeAndStoreUser({ gamification: gsData });
                        }
                    } catch (e) {
                        if (window.GTG_DEBUG) console.warn('[Perfil] fallback gamification/status fall√≥', e);
                    }
                }

                applyUserToUI(merged, { silent });
                return merged;
            } catch (e) {
                if (window.GTG_DEBUG) console.warn('[Perfil] fetchUserProfile fall√≥', e);
                return null;
            }
        }

        async function refreshProfile(opts = {}) {
            const silent = opts.silent !== false;
            const stored = getStoredUser();
            if (!stored) return;
            applyUserToUI(stored, { silent: true });
            await fetchUserProfile({ silent });
        }

        async function claimDailyReward() {
            if (!window.API_URL || typeof authFetch !== 'function') return;
            const claimBtn = document.getElementById('claimDailyBtn');
            if (claimBtn && claimBtn.disabled) return;

            const prevText = claimBtn ? claimBtn.textContent : '';
            if (claimBtn) {
                claimBtn.disabled = true;
                claimBtn.style.opacity = '0.7';
                claimBtn.style.cursor = 'default';
                claimBtn.textContent = 'Verificando...';
            }

            const syncDailyStateFallback = async () => {
                try {
                    const gsRes = await authFetch(`${API_URL}gamification/status/`);
                    if (!gsRes.ok) return null;
                    const gsData = await gsRes.json();
                    const merged = mergeAndStoreUser({ gamification: gsData });
                    applyUserToUI(merged, { silent: true });
                    return merged;
                } catch (e) {
                    return null;
                }
            };

            try {
                const res = await authFetch(`${API_URL}gamification/claim_daily/`, { method: 'POST' });
                if (!res.ok) {
                    const merged = await syncDailyStateFallback();
                    const claimed = !!(merged && merged.gamification && merged.gamification.wow && merged.gamification.wow.daily_reward && merged.gamification.wow.daily_reward.claimed_today);
                    if (claimed) {
                        showFxToast('Recompensa diaria ya reclamada');
                        showToast('La recompensa de hoy ya fue reclamada.', 'success');
                        return;
                    }
                    if (res.status === 404) {
                        showFxToast('Recompensa diaria no disponible en esta versi√≥n del backend');
                        showToast('Recompensa diaria no disponible en este momento.', 'error');
                        return;
                    }
                    showToast('No se pudo reclamar la recompensa diaria. Int√©ntalo de nuevo.', 'error');
                    return;
                }
                const data = await res.json();
                if (data && data.gamification) {
                    const merged = mergeAndStoreUser({ gamification: data.gamification });
                    applyUserToUI(merged, { silent: true });
                }
                if (data && data.claimed) {
                    showFxToast(`¬°+${Number(data.reward || 0)} WOW! Recompensa diaria reclamada`);
                    showToast(`+${Number(data.reward || 0)} puntos diarios`, 'success');
                } else {
                    showFxToast('Recompensa diaria ya reclamada');
                    showToast('La recompensa de hoy ya fue reclamada.', 'success');
                }
            } catch (e) {
                if (window.GTG_DEBUG) console.warn('[Perfil] claimDailyReward fall√≥', e);
                const merged = await syncDailyStateFallback();
                const claimed = !!(merged && merged.gamification && merged.gamification.wow && merged.gamification.wow.daily_reward && merged.gamification.wow.daily_reward.claimed_today);
                if (claimed) {
                    showFxToast('Recompensa diaria ya reclamada');
                    showToast('La recompensa de hoy ya fue reclamada.', 'success');
                } else {
                    showToast('No se pudo reclamar la recompensa diaria.', 'error');
                }
            } finally {
                if (claimBtn && claimBtn.textContent === 'Verificando...') {
                    claimBtn.textContent = prevText || 'Reclamar recompensa diaria';
                    claimBtn.disabled = false;
                    claimBtn.style.opacity = '1';
                    claimBtn.style.cursor = 'pointer';
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            syncSfxToggleUi();
            const user = getStoredUser();
            
            if (!user) {
                // For demo purposes if run directly without login, show dummy data or redirect
                // window.location.href='../../auth/indexInicioDeSesion.html';
                // return;
                
                // FALLBACK FOR PREVIEW IF EMPTY (Remove for prod)
                console.log("No user data found, using fallback for UI check");
                document.getElementById('userName').textContent = "Nombres y apellidos";
                document.getElementById('userProfession').textContent = "Profesion";
                document.getElementById("stat-weight").innerText = "70";
                document.getElementById("stat-height").innerText = "1.8";
                document.getElementById("stat-age").innerText = "30";
                return;
            }

            applyUserToUI(user, { silent: true });
            refreshProfile({ silent: true });
        });

        // Important: cuando vuelves desde otra p√°gina en m√≥vil/desktop, el navegador puede restaurar
        // Perfil desde bfcache y NO dispara DOMContentLoaded. Usamos pageshow/visibility para recargar.
        window.addEventListener('pageshow', () => {
            refreshProfile({ silent: true });
        });
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                refreshProfile({ silent: true });
            }
        });
        window.addEventListener('focus', () => {
            refreshProfile({ silent: true });
        });
        window.addEventListener('storage', (event) => {
            if (event && event.key === 'user') {
                refreshProfile({ silent: true });
            }
        });
        
        function cerrarSesion() {
            localStorage.removeItem("user");
            localStorage.removeItem("isLoggedIn");
            window.location.href = '/pages/auth/indexInicioDeSesion.html';
        }
        
        function showToast(message, type = "success") {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = "block";
            setTimeout(() => toast.style.display = "none", 3000);
        }

        function logAvatarLoadFailure(scope, finalUrl, errorEvent) {
            if (!window.GTG_DEBUG) return;
            console.debug(`[Avatar][${scope}] load failed:`, finalUrl, errorEvent);
        }
    </script>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW Registered:', registration.scope))
                .catch(err => console.log('SW Registration Failed:', err));
                
                // Listen for updates from SW
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data && event.data.type === 'REFRESH_PROFILE') {
                        console.log("Recibida actualizaci√≥n desde notificaci√≥n");
                        fetchUserProfile(); // Refresh data
                    }
                });
            });
        }
        
        async function loadChart(username) {
            try {
                const res = await authFetch(`${API_URL}users/history/?username=${username}`);
                if (!res.ok) return;
                const data = await res.json();
                
                // Labels (Dates) and Values
                const labels = data.map(d => d.date);
                const values = data.map(d => d.value);
                
                const ctx = document.getElementById('happinessChart').getContext('2d');
                
                // Destroy old if exists (simple check or let it redraw since page reload)
                if (window.myChart) window.myChart.destroy();
                
                const styles = getComputedStyle(document.body);
                const primary = styles.getPropertyValue('--primary').trim() || '#0FBFB0';
                const textMuted = styles.getPropertyValue('--text-muted').trim() || '#a0a0a0';
                const isLight = document.body.dataset.theme === 'light';
                const gridColor = isLight ? 'rgba(16,16,18,0.12)' : 'rgba(255,255,255,0.1)';
                const primaryFill = hexToRgba(primary, 0.1);

                window.myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '√çndice de Felicidad',
                            data: values,
                            borderColor: primary,
                            backgroundColor: primaryFill,
                            borderWidth: 2,
                            tension: 0.4, // Smooth curves
                            pointRadius: 3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                grid: { color: gridColor },
                                ticks: { color: textMuted }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: textMuted, maxTicksLimit: 5 }
                            }
                        }
                    }
                });
                
            } catch (e) {
                console.error("Error loading chart", e);
            }
        }

        function hexToRgba(hex, alpha) {
            const cleaned = hex.replace('#', '').trim();
            if (cleaned.length !== 6) return `rgba(15, 191, 176, ${alpha})`;
            const r = parseInt(cleaned.slice(0, 2), 16);
            const g = parseInt(cleaned.slice(2, 4), 16);
            const b = parseInt(cleaned.slice(4, 6), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
    </script>
</body>

</html>
